#!/bin/bash
LANG=en_US.UTF-8
release="$(lsb_release -rs)"
codename="$(lsb_release -cs)"

#detect currently logged in username and home dir and work-around recreating the files as root
if [[ ! -e /tmp/.yppa_username ]]; then
	whoami > /tmp/.yppa_username
fi
if [[ ! -e /tmp/.yppa_home ]]; then
	echo ~ > /tmp/.yppa_home
fi
loggeduser=$(cat /tmp/.yppa_username)
homedir=$(cat /tmp/.yppa_home)

######notification daemon
#notifydaemonrunning=$(ps -e | grep y-ppa-notify)
#[[ ! $notifydaemonrunning ]] && y-ppa-notify &

######policykit fix for KDE not setting XAUTHORITY
#sometimes y-pkexec may be called as root by y-ppa-manager so let's fix ~/.Xauthoriy and use $homedir/.Xauthority when that happens
if [[ "$release" > "11.04" || "$codename" = "lisa" || "$codename" = "maya" || "$codename" = "nadia" || "$codename" = "olivia" || "$codename" = "petra" || "$codename" = "luna" ]]; then
	if [[ -z "$XAUTHORITY" ]]; then
		export XAUTHORITY="$homedir/.Xauthority"
	fi
###################################################
	case $1 in
		add)
			pkexec y-ppa-cmd add;;
		advanced)
			pkexec y-ppa-cmd advanced;;
		manage)
			pkexec y-ppa-cmd manage;;
		search)
			pkexec y-ppa-search;;
		settings)
			pkexec y-ppa-cmd settings;;
		install)
			pkexec y-ppa-cmd install;;
		*)
			y-ppa-indicator &
			pkexec y-ppa-manager;;
	esac

else
	if [[ -e /usr/bin/gksu ]]; then
		case $1 in
			add)
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-cmd add;;
			advanced)
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-cmd advanced;;
			manage)
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-cmd manage;;
			search)
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-search;;
			settings)
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-cmd settings;;
			install)
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-cmd install;;
			*)
				y-ppa-indicator &
				gksu -S -m "Y PPA Manager requires admin privileges for this task" y-ppa-manager;;
		esac
	elif [[ -e /usr/bin/kdesudo ]]; then
		case $1 in
			add)
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-cmd add;;
			advanced)
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-cmd advanced;;
			manage)
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-cmd manage;;
			search)
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-search;;
			settings)
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-cmd settings;;
			install)
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-cmd install;;
			*)
				y-ppa-indicator &
				kdesudo -d --comment="Y PPA Manager requires admin privileges for this task" y-ppa-manager;;
		esac
	else
		echo "No authentication program found."
		exit 1
	fi
fi
